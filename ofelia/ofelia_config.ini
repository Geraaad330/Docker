[global]

# --- ZADANIE DLA NEXTCLOUD ---
[job-exec "backup-nextcloud"]
# 0 sekund, 0 minut, godzina 3 nad ranem, każdego dnia (* * *)
schedule = 0 0 3 * * *
container = nextcloud-db
# Komenda: mariadb-dump z hasłem z env, zapis do pliku z datą
command = /bin/bash -c 'MYSQL_PWD="$MYSQL_ROOT_PASSWORD" mariadb-dump -u root --all-databases > /backups/dumps/ofelia-nextcloud-$(date +%F).sql'

# --- ZADANIE DLA WALLABAG ---
[job-exec "backup-wallabag"]
schedule = 0 0 3 * * *
container = wallabag-db-1
command = /bin/bash -c 'MYSQL_PWD="$MYSQL_ROOT_PASSWORD" mariadb-dump -u root --all-databases > /backups/dumps/ofelia-wallabag-$(date +%F).sql'

# --- ZADANIE DLA AUTHENTIK ---
[job-exec "backup-authentik"]
# Start o 3:05 (5 minut po innych, żeby nie obciążać CPU startem)
schedule = 0 5 3 * * *
container = authentik-postgresql-1
command = /bin/bash -c 'PGPASSWORD="$POSTGRES_PASSWORD" pg_dumpall -U "$POSTGRES_USER" --clean --if-exists > /backups/dumps/ofelia-authentik-$(date +%F).sql'

# --- CZYSZCZENIE STARYCH BACKUPÓW ---
[job-exec "cleanup-old-backups"]
# Uruchom o 3:30 w nocy (pół godziny po zrobieniu backupu)
schedule = 0 30 3 * * *
container = nextcloud-db
# Znajdź pliki .sql w folderze backupów, które są starsze niż 7 dni i je usuń
command = find /backups/dumps -name "*.sql" -type f -mtime +7 -delete
